# GitHub Actions Workflow for Monorepo - 90 Days AI Engineering
# Each project is separated into its own job for parallel execution and clear status.

name: Monorepo CI/CD

on:
  push:
    branches: 
      - main
      - development
      - 'project-*'
      - 'feature/*'
    paths:
      - 'project_#1_env-semantic-search/**'
      - 'project_#2_climate-qa-rag/**'
      - 'project_#3_Multi-Agent Environmental Research System/**'
      - 'project_#4_Environmental Domain LLM Fine-tuning/**'
      - 'project_#5_EIA Generator - Capstone Project/**'
      - '.github/workflows/monorepo-ci.yml'
      - 'README.md'
  pull_request:
    branches: [ main ]
    paths:
      - 'project_#1_env-semantic-search/**'
      - 'project_#2_climate-qa-rag/**'
      - 'project_#3_Multi-Agent Environmental Research System/**'
      - 'project_#4_Environmental Domain LLM Fine-tuning/**'
      - 'project_#5_EIA Generator - Capstone Project/**'
      - 'README.md'

jobs:
  # Job to filter which projects have changes
  changes:
    runs-on: ubuntu-latest
    outputs:
      project1: ${{ steps.filter.outputs.project1 }}
      project2: ${{ steps.filter.outputs.project2 }}
      project3: ${{ steps.filter.outputs.project3 }}
      project4: ${{ steps.filter.outputs.project4 }}
      project5: ${{ steps.filter.outputs.project5 }}
    steps:
      - uses: actions/checkout@v4
      - uses: dorny/paths-filter@v3
        id: filter
        with:
          filters: |
            project1: 'project_#1_env-semantic-search/**'
            project2: 'project_#2_climate-qa-rag/**'
            project3: 'project_#3_Multi-Agent Environmental Research System/**'
            project4: 'project_#4_Environmental Domain LLM Fine-tuning/**'
            project5: 'project_#5_EIA Generator - Capstone Project/**'

  # Job for Project 1 - Environmental Semantic Search
  project-1:
    needs: changes
    if: ${{ needs.changes.outputs.project1 == 'true' }}
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
      - name: Install dependencies
        working-directory: './project_#1_env-semantic-search'
        run: |
          if [ -f "requirements.txt" ]; then
            pip install -r requirements.txt
          fi
      - name: CI Project 1
        run: echo "Project 1 health check passed"

  # Job for Project 2 - Climate QA RAG
  project-2:
    needs: changes
    if: ${{ needs.changes.outputs.project2 == 'true' }}
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
      - name: Install dependencies
        working-directory: './project_#2_climate-qa-rag'
        run: |
          if [ -f "requirements.txt" ]; then
            pip install -r requirements.txt
          fi
      - name: CI Project 2
        run: echo "Project 2 health check passed"

  # Job for Project 3 - Multi-Agent Environmental Research System
  project-3:
    needs: changes
    if: ${{ needs.changes.outputs.project3 == 'true' }}
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
      - name: Install dependencies
        working-directory: './project_#3_Multi-Agent Environmental Research System'
        run: |
          if [ -f "requirements.txt" ]; then
            pip install -r requirements.txt
          fi
      - name: CI Project 3
        run: echo "Project 3 health check passed"

  # Job for Project 4 - Environmental Domain LLM Fine-tuning
  project-4:
    needs: changes
    if: ${{ needs.changes.outputs.project4 == 'true' }}
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
      - name: Install dependencies
        working-directory: './project_#4_Environmental Domain LLM Fine-tuning'
        run: |
          if [ -f "requirements.txt" ]; then
            pip install -r requirements.txt
          fi
      - name: CI Project 4
        run: echo "Project 4 health check passed"

  # Job for Project 5 - EIA Generator (Capstone)
  project-5:
    needs: changes
    if: ${{ needs.changes.outputs.project5 == 'true' }}
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'
          cache-dependency-path: 'project_#5_EIA Generator - Capstone Project/requirements.txt'
      - name: Install dependencies
        working-directory: './project_#5_EIA Generator - Capstone Project'
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          pip install flake8 pytest
      - name: Lint
        working-directory: './project_#5_EIA Generator - Capstone Project'
        run: |
          flake8 . --count --select=E9,F63,F7,F82 --show-source --statistics
      - name: Test
        working-directory: './project_#5_EIA Generator - Capstone Project'
        env:
          GOOGLE_API_KEY: ${{ secrets.GOOGLE_API_KEY }}
        run: |
          if [ -d "tests" ]; then
            pytest tests/
          fi

  # Deployment Info and Summary
  deploy-summary:
    runs-on: ubuntu-latest
    needs: [project-1, project-2, project-3, project-4, project-5]
    if: always()
    steps:
      - name: Deployment Instructions
        run: |
          echo "## ðŸš€ CI Project Status" >> $GITHUB_STEP_SUMMARY
          echo "Projects CI cycles completed." >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸŒ Streamlit Deployment (Project #5)" >> $GITHUB_STEP_SUMMARY
          echo "1. Go to [share.streamlit.io](https://share.streamlit.io)" >> $GITHUB_STEP_SUMMARY
          echo "2. Path: \`project_#5_EIA Generator - Capstone Project/app.py\`" >> $GITHUB_STEP_SUMMARY

  # Automatically create and Merge Pull Request to main
  create-and-merge-pr:
    runs-on: ubuntu-latest
    needs: [project-1, project-2, project-3, project-4, project-5]
    if: github.event_name == 'push' && github.ref_name != 'main' && github.ref_name != 'development'
    permissions:
      pull-requests: write
      contents: write
    steps:
      - uses: actions/checkout@v4
      - name: PR Flow
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          gh pr create \
            --base main \
            --head ${{ github.ref_name }} \
            --title "ðŸš€ Auto PR: ${{ github.ref_name }} to main" \
            --body "CI passed. Auto-PR created for branch: ${{ github.ref_name }}" \
            || echo "PR already exists."
          
          gh pr merge ${{ github.ref_name }} --auto --merge
