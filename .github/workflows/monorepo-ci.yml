# GitHub Actions Workflow for Monorepo - 90 Days AI Engineering
# This workflow runs CI for all 5 projects in the workspace.

name: Monorepo CI/CD

on:
  push:
    branches: [ main, development ]
    paths:
      - 'project_#1_env-semantic-search/**'
      - 'project_#2_climate-qa-rag/**'
      - 'project_#3_Multi-Agent Environmental Research System/**'
      - 'project_#4_Environmental Domain LLM Fine-tuning/**'
      - 'project_#5_EIA Generator - Capstone Project/**'
      - '.github/workflows/monorepo-ci.yml'
  pull_request:
    branches: [ main ]
    paths:
      - 'project_#1_env-semantic-search/**'
      - 'project_#2_climate-qa-rag/**'
      - 'project_#3_Multi-Agent Environmental Research System/**'
      - 'project_#4_Environmental Domain LLM Fine-tuning/**'
      - 'project_#5_EIA Generator - Capstone Project/**'

jobs:
  # Check if changes are in project 5 (Capstone)
  project-5-ci:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'
          cache-dependency-path: 'project_#5_EIA Generator - Capstone Project/requirements.txt'
      
      - name: Install dependencies
        working-directory: './project_#5_EIA Generator - Capstone Project'
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          pip install flake8 pytest
          
      - name: Lint with flake8
        working-directory: './project_#5_EIA Generator - Capstone Project'
        run: |
          # stop the build if there are Python syntax errors or undefined names
          flake8 . --count --select=E9,F63,F7,F82 --show-source --statistics
          # exit-zero treats all errors as warnings. The GitHub editor is 127 chars wide
          flake8 . --count --exit-zero --max-complexity=10 --max-line-length=127 --statistics

      - name: Test Project 5
        working-directory: './project_#5_EIA Generator - Capstone Project'
        env:
          GOOGLE_API_KEY: ${{ secrets.GOOGLE_API_KEY }}
        run: |
          # Only run if tests directory exists
          if [ -d "tests" ]; then
            pytest tests/
          else
            echo "No tests found for Project 5"
          fi

  # Job for Project 2 (Climate QA RAG)
  project-2-ci:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'
          cache-dependency-path: 'project_#2_climate-qa-rag/requirements.txt'
      - name: Install dependencies
        working-directory: './project_#2_climate-qa-rag'
        run: pip install -r requirements.txt
      - name: Run CI
        working-directory: './project_#2_climate-qa-rag'
        run: echo "Project 2 CI placeholder"

  # Generic check for other projects
  other-projects-ci:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        project: ["project_#1_env-semantic-search", "project_#3_Multi-Agent Environmental Research System", "project_#4_Environmental Domain LLM Fine-tuning"]
    steps:
      - uses: actions/checkout@v4
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
      - name: Install dependencies
        run: |
          if [ -f "${{ matrix.project }}/requirements.txt" ]; then
            pip install -r "${{ matrix.project }}/requirements.txt"
          fi
      - name: Check Project
        run: echo "Checking ${{ matrix.project }}"

  # Final Deployment Status Information
  deploy-info:
    runs-on: ubuntu-latest
    needs: [project-5-ci, project-2-ci, other-projects-ci]
    steps:
      - name: Deploy Summary
        run: |
          echo "## ðŸš€ CI Project Status" >> $GITHUB_STEP_SUMMARY
          echo "All projects passed health checks." >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸŒ Streamlit Deployment Info" >> $GITHUB_STEP_SUMMARY
          echo "To deploy to Streamlit Cloud:" >> $GITHUB_STEP_SUMMARY
          echo "1. Go to [share.streamlit.io](https://share.streamlit.io)" >> $GITHUB_STEP_SUMMARY
          echo "2. Connect this GitHub repository." >> $GITHUB_STEP_SUMMARY
          echo "3. Main file path: \`project_#5_EIA Generator - Capstone Project/app.py\`" >> $GITHUB_STEP_SUMMARY
          echo "4. Set Python version to 3.11+" >> $GITHUB_STEP_SUMMARY
          echo "5. Add Secret \`GOOGLE_API_KEY\` in Streamlit Settings." >> $GITHUB_STEP_SUMMARY
