# GitHub Actions Workflow for Project #2 - Climate QA RAG
# This workflow runs tests and automatically merges feature branches to main

name: Project 2 - Climate QA RAG CI/CD

on:
  push:
    branches:
      - 'feature/project-2-*'
    paths:
      - 'project_#2_climate-qa-rag/**'
      - '.github/workflows/project-2-ci.yml'
  pull_request:
    branches:
      - main
    paths:
      - 'project_#2_climate-qa-rag/**'
      - '.github/workflows/project-2-ci.yml'

jobs:
  test:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
      
      # Cache pip packages - s·∫Ω l∆∞u l·∫°i packages ƒë√£ t·∫£i
      - name: Cache pip packages
        uses: actions/cache@v4
        id: cache-pip
        with:
          path: ~/.cache/pip
          key: ${{ runner.os }}-pip-${{ hashFiles('project_#2_climate-qa-rag/requirements.txt') }}
          restore-keys: |
            ${{ runner.os }}-pip-
      
      # Cache virtual environment - l∆∞u c·∫£ m√¥i tr∆∞·ªùng ƒë√£ c√†i ƒë·∫∑t
      - name: Cache virtual environment
        uses: actions/cache@v4
        id: cache-venv
        with:
          path: project_#2_climate-qa-rag/.venv
          key: ${{ runner.os }}-venv-${{ hashFiles('project_#2_climate-qa-rag/requirements.txt') }}
          restore-keys: |
            ${{ runner.os }}-venv-
      
      - name: Install dependencies
        working-directory: ./project_#2_climate-qa-rag
        run: |
          python -m pip install --upgrade pip
          # Ch·ªâ c√†i ƒë·∫∑t n·∫øu cache kh√¥ng c√≥ ho·∫∑c requirements thay ƒë·ªïi
          if [ ! -d ".venv" ] || [ "${{ steps.cache-venv.outputs.cache-hit }}" != "true" ]; then
            python -m venv .venv
            source .venv/bin/activate
            pip install -r requirements.txt
            pip install pytest pytest-cov flake8
          fi
      
      - name: Run linting
        working-directory: ./project_#2_climate-qa-rag
        run: |
          source .venv/bin/activate
          flake8 src/ --count --select=E9,F63,F7,F82 --show-source --statistics || true
      
      - name: Run tests
        working-directory: ./project_#2_climate-qa-rag
        env:
          GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
        run: |
          source .venv/bin/activate
          pytest tests/ -v --tb=short || echo "No tests found or tests skipped"

  # Job ƒë·ªÉ t·ª± ƒë·ªông t·∫°o PR t·ª´ feature branch
  create-pr:
    runs-on: ubuntu-latest
    needs: test
    if: github.event_name == 'push' && startsWith(github.ref, 'refs/heads/feature/project-2-')
    
    permissions:
      contents: write
      pull-requests: write
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      
      - name: Create Pull Request
        uses: peter-evans/create-pull-request@v6
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          branch: ${{ github.ref_name }}
          base: main
          title: "üöÄ Merge Project 2 - Climate QA RAG updates"
          body: |
            ## Automatic PR from feature branch
            
            This PR was automatically created by GitHub Actions.
            
            **Branch:** `${{ github.ref_name }}`
            **Commit:** `${{ github.sha }}`
            
            ### Changes
            - Updates to Climate QA RAG project
            - All tests passed ‚úÖ
          labels: |
            automated-pr
            project-2
          draft: false

  # Job ƒë·ªÉ merge PR sau khi tests pass
  auto-merge:
    runs-on: ubuntu-latest
    needs: test
    if: github.event_name == 'pull_request'
    
    permissions:
      contents: write
      pull-requests: write
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Merge Pull Request
        uses: pascalgn/automerge-action@v0.16.4
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          MERGE_LABELS: ""
          MERGE_METHOD: "squash"
          MERGE_COMMIT_MESSAGE: "pull-request-title"
          MERGE_DELETE_BRANCH: "true"
