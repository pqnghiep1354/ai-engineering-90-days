# GitHub Actions Workflow for Project #2 - Climate QA RAG
# This workflow runs tests and automatically merges feature branches to main

name: Project 2 - Climate QA RAG CI/CD

on:
  push:
    branches:
      - 'feature/project-2-*'
    paths:
      - 'project_#2_climate-qa-rag/**'
  pull_request:
    branches:
      - main
    paths:
      - 'project_#2_climate-qa-rag/**'

jobs:
  test:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'
      
      - name: Install dependencies
        working-directory: ./project_#2_climate-qa-rag
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          pip install pytest pytest-cov
      
      - name: Run linting
        working-directory: ./project_#2_climate-qa-rag
        run: |
          pip install flake8
          flake8 src/ --count --select=E9,F63,F7,F82 --show-source --statistics || true
      
      - name: Run tests
        working-directory: ./project_#2_climate-qa-rag
        env:
          GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
        run: |
          pytest tests/ -v --tb=short || echo "No tests found or tests skipped"

  auto-merge:
    runs-on: ubuntu-latest
    needs: test
    if: github.event_name == 'pull_request' && github.base_ref == 'main'
    
    permissions:
      contents: write
      pull-requests: write
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      
      - name: Auto-merge PR
        uses: peter-evans/enable-pull-request-automerge@v3
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          pull-request-number: ${{ github.event.pull_request.number }}
          merge-method: squash
